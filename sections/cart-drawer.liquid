<cart-drawer {% if request.design_mode %}handle-section-events{% endif %} class="cart-drawer drawer drawer--lg" id="cart-drawer">
  {%- if cart.item_count == 0 -%}
    <button is="close-button" aria-label="{{ 'general.accessibility.close' | t | escape }}" class="absolute top-4 right-4 z-10 p-3 hover:bg-gray-100 rounded-full transition-all duration-200 hover:scale-110 active:scale-95">
      {%- render 'icon' with 'close' -%}
    </button>

    <div class="empty-state align-self-center px-4 py-8">
      <div class="empty-state__icon-wrapper text-center mb-6">
        {%- render 'icon' with 'cart', width: 40, height: 40, stroke_width: 1, class: 'mx-auto text-gray-400' -%}
        <span class="count-bubble count-bubble--lg inline-block mt-2">0</span>
      </div>

      <div class="prose text-center max-w-sm mx-auto">
        <p class="h5 mb-6 text-gray-600">{{ 'cart.general.empty' | t }}</p>

        {%- assign button_content = 'cart.general.continue_shopping' | t -%}
        <div class="w-full">
          <a href="{{ settings.cart_empty_button_link }}" class="button button--xl w-full sm:w-auto inline-block text-center px-8 py-4 bg-black text-white rounded-xl hover:bg-gray-800 active:bg-gray-900 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]">
            {{ button_content }}
          </a>
        </div>
      </div>
    </div>
  {%- else -%}
    <div class="cart-drawer__inner flex flex-col h-full">
      <div class="cart-drawer__top px-4 py-4 border-b border-gray-200 flex-shrink-0">
        <div class="h-stack items-center justify-between mb-4">
          <div class="h-stack grow gap-2 sm:gap-3 items-center">
            <p class="h5 mb-0">{{- 'cart.general.title' | t -}}</p>
            <cart-count class="count-bubble count-bubble--md bg-black text-white">{{ cart.item_count }}</cart-count>
          </div>

          <button type="button" is="close-button" class="drawer__close-icon p-3 hover:bg-gray-100 rounded-full transition-all duration-200 hover:scale-110 active:scale-95 ml-4">
            <span class="sr-only">{{ 'general.accessibility.close' | t }}</span>
            {%- render 'icon' with 'close' -%}
          </button>
        </div>

        {%- if settings.cart_show_free_shipping_threshold -%}
          <div class="mt-4">
            {%- render 'free-shipping-bar' -%}
          </div>
        {%- endif -%}
      </div>

      <div class="flex-1 overflow-y-auto px-4 py-4">
        <div class="v-stack gap-6 sm:gap-8">
          <div class="cart-drawer__line-items space-y-4">
            {%- for line_item in cart.items -%}
              <div class="border-b border-gray-100 pb-4 last:border-b-0">
                <div class="flex gap-3 items-start">
                  <div class="flex-shrink-0">
                    <img src="{{ line_item.image | image_url: width: 80 }}" alt="{{ line_item.title | escape }}" class="w-20 h-20 object-cover rounded-lg">
                  </div>
                  
                  <div class="flex-1 min-w-0">
                    <h3 class="font-medium text-gray-900 truncate">{{ line_item.product.title }}</h3>
                    {%- if line_item.variant.title != 'Default Title' -%}
                      <p class="text-sm text-gray-500">{{ line_item.variant.title }}</p>
                    {%- endif -%}
                    <p class="text-sm font-medium text-gray-900 mt-1">{{ line_item.final_price | money }}</p>
                    
                    <div class="flex items-center gap-3 mt-3">
                      <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                        <button type="button" class="quantity-decrease px-3 py-2 hover:bg-gray-100 transition-colors text-gray-600 hover:text-gray-900 font-medium" data-line="{{ forloop.index }}" onclick="updateQuantity({{ forloop.index }}, {{ line_item.quantity | minus: 1 }})">-</button>
                        <span class="px-3 py-2 min-w-[3rem] text-center font-medium border-l border-r border-gray-300">{{ line_item.quantity }}</span>
                        <button type="button" class="quantity-increase px-3 py-2 hover:bg-gray-100 transition-colors text-gray-600 hover:text-gray-900 font-medium" data-line="{{ forloop.index }}" onclick="updateQuantity({{ forloop.index }}, {{ line_item.quantity | plus: 1 }})">+</button>
                      </div>
                      
                      <button type="button" class="text-sm text-red-600 hover:text-red-800 underline" onclick="updateQuantity({{ forloop.index }}, 0)">
                        Supprimer
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {%- endfor -%}
          </div>

          {%- if section.settings.products.count > 0 -%}
            <div class="cart-drawer__recommendations">
              <div class="v-stack gap-3 sm:gap-4">
                {%- capture carousel_id -%}cart-drawer-recommendations{%- endcapture -%}

                {%- liquid
                  assign horizontal_products_blends = true
                  assign product_card_background = section.settings.product_card_background | default: product.settings.product_card_background

                  if product_card_background != 'rgba(0,0,0,0)' and product_card_background != blank and product_card_background != settings.dialog_background
                    assign horizontal_products_blends = false
                  endif

                  assign rendered_recommendations = 0

                  capture recommendations
                    for recommended_product in section.settings.products
                      assign item_count_in_cart = cart | line_items_for: recommended_product

                      if item_count_in_cart.size == 0
                        render 'horizontal-product', product: recommended_product, show_add_to_cart: true, background: section.settings.product_card_background, text_color: section.settings.product_card_text_color
                        assign rendered_recommendations = rendered_recommendations | plus: 1
                      endif
                    endfor
                  endcapture
                -%}

                {%- if rendered_recommendations > 0 -%}
                  <div class="flex justify-between items-center gap-4">
                    {%- if section.settings.recommendations_title != blank -%}
                      <p class="font-medium text-gray-900 mb-0">{{ section.settings.recommendations_title | escape }}</p>
                    {%- endif -%}

                    {%- if rendered_recommendations > 1 -%}
                      <div class="h-stack gap-2 hidden sm:flex">
                        <button is="prev-button" class="circle-chevron hover:colors p-2 rounded-full border-2 border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 hover:scale-110 active:scale-95" aria-controls="{{ carousel_id }}" aria-label="{{ 'general.accessibility.previous' | t | escape }}" disabled>{%- render 'icon' with 'chevron-left-small', direction_aware: true -%}</button>
                        <button is="next-button" class="circle-chevron hover:colors p-2 rounded-full border-2 border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 hover:scale-110 active:scale-95" aria-controls="{{ carousel_id }}" aria-label="{{ 'general.accessibility.next' | t | escape }}">{%- render 'icon' with 'chevron-right-small', direction_aware: true -%}</button>
                      </div>
                    {%- endif -%}
                  </div>
                {%- endif -%}

                {%- if recommendations != blank -%}
                  <scroll-carousel selector=".horizontal-product" id="{{ carousel_id }}" class="horizontal-product-list-carousel {% unless horizontal_products_blends %}separate{% endunless %} scroll-area bleed -mx-4 px-4">
                    <div class="horizontal-product-list {% if horizontal_products_blends %}divide-x{% else %}separate{% endif %} gap-3">
                      {{- recommendations -}}
                    </div>
                  </scroll-carousel>
                {%- endif -%}
              </div>
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>

    <div class="border-t border-gray-200 px-4 py-4 bg-white flex-shrink-0" slot="footer">
      <div class="v-stack gap-4 sm:gap-6">
        <div class="v-stack gap-3">
          {% for discount_application in cart.cart_level_discount_applications %}
            <div class="flex justify-between items-center py-2">
              <div class="badge flex items-center gap-2 bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                {%- render 'icon' with 'discount', class: 'w-4 h-4' -%} 
                <span>{{- discount_application.title -}}</span>
              </div>
              <span class="text-green-600 font-medium">-{{ discount_application.total_allocated_amount | money }}</span>
            </div>
          {% endfor %}

          <div class="flex justify-between items-center py-3 border-t border-gray-200">
            <span class="h5 mb-0 font-semibold">{{ 'cart.general.total' | t }}</span>
            <span class="h5 mb-0 font-semibold text-lg">{{- cart.total_price | money_with_currency -}}</span>
          </div>

          {%- if section.settings.show_shipping_text -%}
            <div class="text-center">
              {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
                <p class="text-gray-500 text-sm leading-relaxed">{{ 'cart.general.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url }}</p>
              {%- elsif cart.taxes_included -%}
                <p class="text-gray-500 text-sm leading-relaxed">{{ 'cart.general.taxes_included_but_shipping_at_checkout' | t }}</p>
              {%- elsif shop.shipping_policy.body != blank -%}
                <p class="text-gray-500 text-sm leading-relaxed">{{ 'cart.general.taxes_and_shipping_policy_at_checkout_html' | t: link: shop.shipping_policy.url }}</p>
              {%- else -%}
                <p class="text-gray-500 text-sm leading-relaxed">{{ 'cart.general.taxes_and_shipping_at_checkout' | t }}</p>
              {%- endif -%}
            </div>
          {%- endif -%}

          {%- if section.settings.show_cart_note -%}
            <div class="text-center">
              <button type="button" class="text-sm text-gray-600 hover:text-gray-900 underline underline-offset-2 hover:underline-offset-4 transition-all duration-200 font-medium" aria-controls="cart-drawer-note">
                <span>
                  {%- if cart.note == blank -%}
                    {{- 'cart.general.add_order_note' | t -}}
                  {%- else -%}
                    {{- 'cart.general.edit_order_note' | t -}}
                  {%- endif -%}
                </span>
              </button>
            </div>

            <cart-note-dialog id="cart-drawer-note" class="cart-drawer__note">
              <div class="cart-drawer__note-inner p-6">
                <div class="v-stack gap-4 sm:gap-6">
                  <p class="h5 mb-0">{{ 'cart.general.order_note' | t }}</p>

                  <cart-note class="v-stack gap-4">
                    {%- assign order_note = 'cart.general.order_note' | t -%}
                    {%- assign order_save_label = 'cart.general.save_note' | t -%}

                    {%- render 'input', name: 'note', multiline: 3, label: order_note, value: cart.note, class: 'w-full' -%}

                    <div class="flex justify-start">
                      {%- render 'button', type: 'button', content: order_save_label, size: 'lg', is: 'close-button', secondary: true, class: 'w-full sm:w-auto' -%}
                    </div>
                  </cart-note>
                </div>
              </div>
            </cart-note-dialog>
          {%- endif -%}
        </div>

        <form action="{{ routes.cart_url }}" method="POST" class="w-full space-y-3">
          {%- if section.settings.show_view_cart_button or section.settings.show_checkout_button == false -%}
            <a href="{{ routes.cart_url }}" class="button button--xl button--secondary w-full text-center block py-4 px-6 border-2 border-gray-300 rounded-xl hover:border-gray-400 hover:bg-gray-50 active:bg-gray-100 transition-all duration-200 font-semibold text-gray-700 hover:text-gray-900 shadow-md hover:shadow-lg transform hover:scale-[1.02] active:scale-[0.98]" data-no-instant>
              {{- 'cart.general.view_cart' | t -}}
            </a>
          {%- endif -%}

          {%- if section.settings.show_checkout_button -%}
            <button type="submit" name="checkout" class="button button--xl w-full bg-black text-white py-4 px-6 rounded-xl hover:bg-gray-800 active:bg-gray-900 transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring-3 focus:ring-black/20 focus:ring-offset-2 transform hover:scale-[1.02] active:scale-[0.98]">
              Acheter
            </button>
          {%- endif -%}
        </form>
      </div>
    </div>
  {%- endif -%}
</cart-drawer>

{% schema %}
{
  "name": "Cart drawer",
  "settings": [
    {
      "type": "paragraph",
      "content": "Cart drawer won't appear to your customers if you have set the cart type to Page in the global theme settings."
    },
    {
      "type": "paragraph",
      "content": "Free shipping bar can be configured in global cart settings."
    },
    {
      "type": "checkbox",
      "id": "show_cart_note",
      "label": "Show cart note",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_shipping_text",
      "label": "Show shipping text",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_view_cart_button",
      "label": "Show view cart button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_checkout_button",
      "label": "Show checkout button",
      "default": true
    },
    {
      "type": "header",
      "content": "Product recommendations"
    },
    {
      "type": "text",
      "id": "recommendations_title",
      "label": "Heading",
      "default": "Trending this month"
    },
    {
      "type": "product_list",
      "id": "products",
      "label": "Recommendations",
      "info": "Suggest additional products to your customers. Recommendations already in the cart are automatically hidden.",
      "limit": 10
    },
    {
      "type": "color",
      "id": "product_card_background",
      "label": "Product card background"
    },
    {
      "type": "color",
      "id": "product_card_text_color",
      "label": "Product card text"
    }
  ]
}
{% endschema %}