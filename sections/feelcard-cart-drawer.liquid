<!-- FEELCARD Cart Drawer - Isolation totale -->
<cart-drawer class="feelcard-cart-overlay" id="feelcard-cart-drawer" 
  {% if request.design_mode %}handle-section-events{% endif %}
  data-state="closed"
  role="dialog" 
  aria-modal="true" 
  aria-labelledby="feelcard-cart-title"
  aria-hidden="true">
  
  <!-- Backdrop isol√© -->
  <div class="feelcard-backdrop" aria-hidden="true"></div>
  
  <!-- Container principal isol√© -->
  <div class="feelcard-drawer-container" role="document">
    
    {%- if cart.item_count == 0 -%}
      <!-- √âtat panier vide avec animations -->
      <div class="feelcard-empty-state">
        <button class="feelcard-close-btn" type="button" aria-label="{{ 'general.accessibility.close' | t | escape }}">
          <svg class="feelcard-close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
        
        <div class="feelcard-empty-content">
          <div class="feelcard-empty-icon-wrapper">
            <div class="feelcard-cart-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
              </svg>
            </div>
            <div class="feelcard-particles">
              <div class="feelcard-particle"></div>
              <div class="feelcard-particle"></div>
              <div class="feelcard-particle"></div>
              <div class="feelcard-particle"></div>
            </div>
          </div>
          
          <div class="feelcard-empty-text">
            <h2 class="feelcard-empty-title">{{ 'cart.general.empty' | t }}</h2>
            <p class="feelcard-empty-subtitle">D√©couvrez nos plaques d'avis personnalis√©es</p>
            <a href="{{ settings.cart_empty_button_link | default: routes.all_products_collection_url }}" 
               class="feelcard-btn feelcard-btn--primary">
              {{ 'cart.general.continue_shopping' | t }}
            </a>
          </div>
        </div>
      </div>
      
    {%- else -%}
      <!-- √âtat avec produits -->
      <div class="feelcard-drawer-content">
        
        <!-- Header -->
        <div class="feelcard-header">
          <div class="feelcard-header-main">
            <h2 id="feelcard-cart-title" class="feelcard-title">
              {{ 'cart.general.title' | t }}
            </h2>
            <div class="feelcard-count-bubble" data-count="{{ cart.item_count }}">
              {{ cart.item_count }}
            </div>
          </div>
          
          <button class="feelcard-close-btn" type="button" aria-label="{{ 'general.accessibility.close' | t | escape }}">
            <svg class="feelcard-close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
          
          {%- if settings.cart_show_free_shipping_threshold -%}
            <div class="feelcard-shipping-bar">
              {%- assign threshold = settings.cart_free_shipping_threshold | times: 100 -%}
              {%- assign current_total = cart.total_price -%}
              {%- assign remaining = threshold | minus: current_total -%}
              
              <div class="feelcard-shipping-progress">
                {%- assign progress = current_total | times: 100 | divided_by: threshold -%}
                {%- if progress > 100 -%}{%- assign progress = 100 -%}{%- endif -%}
                <div class="feelcard-progress-bar" style="--progress: {{ progress }}%"></div>
              </div>
              
              <p class="feelcard-shipping-text">
                {%- if remaining > 0 -%}
                  Plus que {{ remaining | money }} pour la livraison gratuite
                {%- else -%}
                  üéâ Livraison gratuite d√©bloqu√©e !
                {%- endif -%}
              </p>
            </div>
          {%- endif -%}
        </div>
        
        <!-- Zone scrollable -->
        <div class="feelcard-scroll-area">
          
          <!-- Liste des produits -->
          <div class="feelcard-line-items">
            {%- for line_item in cart.items -%}
              <div class="feelcard-line-item" data-line-key="{{ line_item.key }}">
                <div class="feelcard-product-image">
                  {%- if line_item.image -%}
                    <img src="{{ line_item.image | image_url: width: 80 }}" 
                         alt="{{ line_item.image.alt | escape }}"
                         loading="lazy">
                  {%- else -%}
                    <div class="feelcard-no-image">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                      </svg>
                    </div>
                  {%- endif -%}
                </div>
                
                <div class="feelcard-product-details">
                  <h3 class="feelcard-product-title">{{ line_item.product.title }}</h3>
                  {%- unless line_item.variant.title contains 'Default' -%}
                    <p class="feelcard-product-variant">{{ line_item.variant.title }}</p>
                  {%- endunless -%}
                  
                  <div class="feelcard-product-meta">
                    <div class="feelcard-quantity-controls">
                      <button class="feelcard-qty-btn" type="button" data-action="decrease" data-line="{{ forloop.index }}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path d="M5 12h14"/>
                        </svg>
                      </button>
                      <input class="feelcard-qty-input" 
                             type="number" 
                             value="{{ line_item.quantity }}" 
                             min="0"
                             data-line="{{ forloop.index }}"
                             aria-label="Quantit√© pour {{ line_item.product.title }}">
                      <button class="feelcard-qty-btn" type="button" data-action="increase" data-line="{{ forloop.index }}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path d="M12 5v14M5 12h14"/>
                        </svg>
                      </button>
                    </div>
                    
                    <div class="feelcard-product-price">
                      {%- if line_item.original_price != line_item.final_price -%}
                        <span class="feelcard-price-original">{{ line_item.original_price | money }}</span>
                        <span class="feelcard-price-final">{{ line_item.final_price | money }}</span>
                      {%- else -%}
                        <span class="feelcard-price">{{ line_item.final_price | money }}</span>
                      {%- endif -%}
                    </div>
                  </div>
                </div>
                
                <button class="feelcard-remove-btn" type="button" data-line="{{ forloop.index }}" aria-label="Supprimer {{ line_item.product.title }}">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="3,6 5,6 21,6"/>
                    <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2v2"/>
                  </svg>
                </button>
              </div>
            {%- endfor -%}
          </div>
          
          <!-- Recommandations -->
          {%- if section.settings.products.count > 0 -%}
            <div class="feelcard-recommendations">
              <div class="feelcard-recommendations-header">
                <h3 class="feelcard-recommendations-title">
                  {{ section.settings.recommendations_title | default: "Recommandations" }}
                </h3>
                <div class="feelcard-carousel-controls">
                  <button class="feelcard-carousel-btn feelcard-carousel-prev" type="button" aria-label="Pr√©c√©dent">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <polyline points="15,18 9,12 15,6"/>
                    </svg>
                  </button>
                  <button class="feelcard-carousel-btn feelcard-carousel-next" type="button" aria-label="Suivant">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <polyline points="9,18 15,12 9,6"/>
                    </svg>
                  </button>
                </div>
              </div>
              
              <div class="feelcard-carousel">
                <div class="feelcard-carousel-track">
                  {%- for recommended_product in section.settings.products limit: 6 -%}
                    {%- assign item_in_cart = false -%}
                    {%- for cart_item in cart.items -%}
                      {%- if cart_item.product.id == recommended_product.id -%}
                        {%- assign item_in_cart = true -%}
                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                    
                    {%- unless item_in_cart -%}
                      <div class="feelcard-recommendation-card">
                        <div class="feelcard-rec-image">
                          {%- if recommended_product.featured_image -%}
                            <img src="{{ recommended_product.featured_image | image_url: width: 120 }}" 
                                 alt="{{ recommended_product.featured_image.alt | escape }}"
                                 loading="lazy">
                          {%- endif -%}
                        </div>
                        <div class="feelcard-rec-details">
                          <h4 class="feelcard-rec-title">{{ recommended_product.title | truncate: 40 }}</h4>
                          <p class="feelcard-rec-price">{{ recommended_product.price | money }}</p>
                          <button class="feelcard-btn feelcard-btn--small" 
                                  type="button" 
                                  data-product-id="{{ recommended_product.id }}"
                                  data-variant-id="{{ recommended_product.selected_or_first_available_variant.id }}">
                            Ajouter
                          </button>
                        </div>
                      </div>
                    {%- endunless -%}
                  {%- endfor -%}
                </div>
              </div>
            </div>
          {%- endif -%}
          
        </div>
        
        <!-- Footer fixe -->
        <div class="feelcard-footer">
          
          <!-- R√©ductions -->
          {%- if cart.cart_level_discount_applications.size > 0 -%}
            <div class="feelcard-discounts">
              {%- for discount in cart.cart_level_discount_applications -%}
                <div class="feelcard-discount-item">
                  <div class="feelcard-discount-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    {{ discount.title }}
                  </div>
                  <span class="feelcard-discount-amount">-{{ discount.total_allocated_amount | money }}</span>
                </div>
              {%- endfor -%}
            </div>
          {%- endif -%}
          
          <!-- Total -->
          <div class="feelcard-total">
            <div class="feelcard-total-line">
              <span class="feelcard-total-label">Total</span>
              <span class="feelcard-total-price">{{ cart.total_price | money_with_currency }}</span>
            </div>
            
            {%- if section.settings.show_shipping_text -%}
              <p class="feelcard-shipping-info">
                {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
                  {{ 'cart.general.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url }}
                {%- elsif cart.taxes_included -%}
                  {{ 'cart.general.taxes_included_but_shipping_at_checkout' | t }}
                {%- else -%}
                  {{ 'cart.general.taxes_and_shipping_at_checkout' | t }}
                {%- endif -%}
              </p>
            {%- endif -%}
          </div>
          
          <!-- Note de commande -->
          {%- if section.settings.show_cart_note -%}
            <button class="feelcard-note-toggle" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10,9 9,9 8,9"/>
              </svg>
              {%- if cart.note == blank -%}
                {{ 'cart.general.add_order_note' | t }}
              {%- else -%}
                {{ 'cart.general.edit_order_note' | t }}
              {%- endif -%}
            </button>
            
            <div class="feelcard-note-modal" data-state="closed">
              <div class="feelcard-note-content">
                <h3>{{ 'cart.general.order_note' | t }}</h3>
                <textarea class="feelcard-note-textarea" 
                          placeholder="Instructions sp√©ciales pour votre commande..."
                          rows="3">{{ cart.note }}</textarea>
                <div class="feelcard-note-actions">
                  <button class="feelcard-btn feelcard-btn--secondary feelcard-note-cancel" type="button">
                    Annuler
                  </button>
                  <button class="feelcard-btn feelcard-btn--primary feelcard-note-save" type="button">
                    Sauvegarder
                  </button>
                </div>
              </div>
            </div>
          {%- endif -%}
          
          <!-- Boutons d'action -->
          <div class="feelcard-actions">
            {%- if section.settings.show_view_cart_button -%}
              <a href="{{ routes.cart_url }}" class="feelcard-btn feelcard-btn--secondary feelcard-btn--full">
                {{ 'cart.general.view_cart' | t }}
              </a>
            {%- endif -%}
            
            {%- if section.settings.show_checkout_button -%}
              <form action="{{ routes.cart_url }}" method="POST" class="feelcard-checkout-form">
                <button type="submit" name="checkout" class="feelcard-btn feelcard-btn--primary feelcard-btn--full">
                  <svg class="feelcard-lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <circle cx="12" cy="16" r="1"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                  </svg>
                  {{ 'cart.general.checkout' | t }}
                  <div class="feelcard-btn-loading">
                    <div class="feelcard-spinner"></div>
                  </div>
                </button>
              </form>
            {%- endif -%}
          </div>
          
          <!-- Badges de confiance -->
          <div class="feelcard-trust-badges">
            <div class="feelcard-trust-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
              <span>Paiement s√©curis√©</span>
            </div>
            <div class="feelcard-trust-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="1" y="3" width="15" height="13"/>
                <polygon points="16,8 20,8 23,11 23,16 16,16 16,8"/>
                <circle cx="5.5" cy="18.5" r="2.5"/>
                <circle cx="18.5" cy="18.5" r="2.5"/>
              </svg>
              <span>Livraison rapide</span>
            </div>
            <div class="feelcard-trust-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="23,4 23,10 17,10"/>
                <polyline points="1,20 1,14 7,14"/>
                <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
              </svg>
              <span>Retours gratuits</span>
            </div>
          </div>
          
        </div>
      </div>
    {%- endif -%}
    
  </div>
</cart-drawer>

<!-- Loading overlay -->
<div class="feelcard-loading-overlay" data-state="hidden">
  <div class="feelcard-loading-content">
    <div class="feelcard-spinner-large"></div>
    <p>Mise √† jour du panier...</p>
  </div>
</div>
